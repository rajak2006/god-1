#!/bin/bash

# Usage: ./check_access.sh <clusterrole.json> <username> <namespace>
JSON_FILE="$1"
USER_NAME="$2"
NAMESPACE="$3"
OUTPUT_FILE="ocp_access_report.txt"

# Validate inputs
if [[ -z "$JSON_FILE" || -z "$USER_NAME" || -z "$NAMESPACE" ]]; then
  echo "Usage: $0 <clusterrole.json> <username> <namespace>"
  exit 1
fi

if ! command -v jq &>/dev/null; then
  echo "jq is required but not installed"
  exit 1
fi

if ! command -v oc &>/dev/null; then
  echo "oc CLI is required but not installed"
  exit 1
fi

# Header
printf "%-25s %-15s %-10s\n" "RESOURCE" "VERB" "ACCESS" > "$OUTPUT_FILE"
printf "%-25s %-15s %-10s\n" "--------" "----" "------" >> "$OUTPUT_FILE"

# Read all rules into an array to avoid subshell issues
mapfile -t rules < <(jq -c '.rules[]' "$JSON_FILE")

for rule in "${rules[@]}"; do
    # Read resources and verbs safely
    mapfile -t resources < <(echo "$rule" | jq -r '.resources[]')
    mapfile -t verbs     < <(echo "$rule" | jq -r '.verbs[]')

    for resource in "${resources[@]}"; do
        [[ "$resource" == "*" ]] && continue  # skip wildcard

        for verb in "${verbs[@]}"; do
            [[ "$verb" == "*" ]] && continue  # skip wildcard

            # Check access using oc
            ALLOWED=$(oc auth can-i "$verb" "$resource" -n "$NAMESPACE" --as="$USER_NAME" -o json 2>/dev/null | jq -r '.allowed')
            RESULT="DENIED"
            [[ "$ALLOWED" == "true" ]] && RESULT="ALLOWED"

            printf "%-25s %-15s %-10s\n" "$resource" "$verb" "$RESULT" >> "$OUTPUT_FILE"
        done
    done
done

echo "‚úÖ Access report generated: $OUTPUT_FILE"


######
#!/bin/bash

# Usage: ./check_access.sh <clusterrole.json> <username> <namespace>
JSON_FILE="$1"
USER_NAME="$2"
NAMESPACE="$3"
OUTPUT_FILE="ocp_access_report.txt"

# Validate inputs
if [[ -z "$JSON_FILE" || -z "$USER_NAME" || -z "$NAMESPACE" ]]; then
  echo "Usage: $0 <clusterrole.json> <username> <namespace>"
  exit 1
fi

if ! command -v jq &>/dev/null; then
  echo "jq is required but not installed"
  exit 1
fi

if ! command -v oc &>/dev/null; then
  echo "oc CLI is required but not installed"
  exit 1
fi

# Header
printf "%-25s %-15s %-10s\n" "RESOURCE" "VERB" "ACCESS" > "$OUTPUT_FILE"
printf "%-25s %-15s %-10s\n" "--------" "----" "------" >> "$OUTPUT_FILE"

# Loop through rules
jq -c '.rules[]' "$JSON_FILE" | while read -r rule; do
  # Loop resources
  for resource in $(echo "$rule" | jq -r '.resources[]'); do
    [[ "$resource" == "*" ]] && continue  # skip wildcard

    # Loop verbs
    for verb in $(echo "$rule" | jq -r '.verbs[]'); do
      [[ "$verb" == "*" ]] && continue  # skip wildcard

      # Check access
      ALLOWED=$(oc auth can-i "$verb" "$resource" -n "$NAMESPACE" --as="$USER_NAME" -o json 2>/dev/null | jq -r '.allowed')
      RESULT="DENIED"
      [[ "$ALLOWED" == "true" ]] && RESULT="ALLOWED"

      printf "%-25s %-15s %-10s\n" "$resource" "$verb" "$RESULT" >> "$OUTPUT_FILE"
    done
  done
done

echo "‚úÖ Access report generated: $OUTPUT_FILE"


#####

#!/bin/bash

# Usage: ./check_access.sh <clusterrole.json> <username> <namespace>
JSON_FILE="$1"
USER_NAME="$2"
NAMESPACE="$3"
OUTPUT_FILE="ocp_access_report.txt"

# Validate inputs
if [[ -z "$JSON_FILE" || -z "$USER_NAME" || -z "$NAMESPACE" ]]; then
  echo "Usage: $0 <clusterrole.json> <username> <namespace>"
  exit 1
fi

if ! command -v jq &>/dev/null; then
  echo "jq is required but not installed"
  exit 1
fi

if ! command -v oc &>/dev/null; then
  echo "oc CLI is required but not installed"
  exit 1
fi

# Header
printf "%-25s %-15s %-10s\n" "RESOURCE" "VERB" "ACCESS" > "$OUTPUT_FILE"
printf "%-25s %-15s %-10s\n" "--------" "----" "------" >> "$OUTPUT_FILE"

# Loop through rules
jq -c '.rules[]' "$JSON_FILE" | while read -r rule; do
  # Get apiGroups (array)
  apiGroups=$(echo "$rule" | jq -r '.apiGroups[]?')
  [[ -z "$apiGroups" ]] && apiGroups=""

  # Loop resources
  for resource in $(echo "$rule" | jq -r '.resources[]'); do
    # Skip wildcard resource
    [[ "$resource" == "*" ]] && continue

    # Loop verbs
    for verb in $(echo "$rule" | jq -r '.verbs[]'); do
      # Skip wildcard verb
      [[ "$verb" == "*" ]] && continue

      # Build full resource name with apiGroup
      full_resources=()
      if [[ -z "$apiGroups" ]]; then
        full_resources+=("$resource")
      else
        for ag in $apiGroups; do
          if [[ "$ag" == "" || "$ag" == "null" ]]; then
            full_resources+=("$resource")
          else
            full_resources+=("$resource.$ag")
          fi
        done
      fi

      # Check each full resource
      for res in "${full_resources[@]}"; do
        ALLOWED=$(oc auth can-i "$verb" "$res" -n "$NAMESPACE" --as="$USER_NAME" -o json 2>/dev/null | jq -r '.allowed')
        if [[ "$ALLOWED" == "true" ]]; then
          RESULT="ALLOWED"
        else
          RESULT="DENIED"
        fi
        printf "%-25s %-15s %-10s\n" "$res" "$verb" "$RESULT" >> "$OUTPUT_FILE"
      done

    done
  done
done

echo "‚úÖ Access report generated: $OUTPUT_FILE"




Yep ‚Äî I know exactly why this is happening üëç
This is a **very common Bash + oc + jq gotcha**.

### Root cause (important)

`oc auth can-i` **prints** `yes` / `no`, but:

* sometimes it prints **nothing** (especially with subresources)
* sometimes it prints to **stderr**
* sometimes extra whitespace breaks your string comparison

So your script is running, but `ACCESS` is empty ‚Üí nothing shows as ALLOWED / DENIED.

---

## ‚úÖ Correct + reliable fix

Use `--output=json` and parse the result **explicitly**.

`oc auth can-i` supports structured output like this:

```bash
oc auth can-i get pods --as=user --output=json
```

Which returns:

```json
{
  "allowed": true
}
```

---

## üî• Fixed Script (this WILL show ALLOWED / DENIED)

### `check_access_from_json.sh`

```bash
#!/bin/bash

JSON_FILE="$1"
USER_NAME="$2"
OUTPUT_FILE="ocp_access_report.txt"

if [[ -z "$JSON_FILE" || -z "$USER_NAME" ]]; then
  echo "Usage: $0 <clusterrole.json> <username>"
  exit 1
fi

if ! command -v jq &>/dev/null; then
  echo "jq is required but not installed"
  exit 1
fi

# Header
printf "%-20s %-20s %-10s\n" "RESOURCE" "VERB" "ACCESS" > "$OUTPUT_FILE"
printf "%-20s %-20s %-10s\n" "--------" "----" "------" >> "$OUTPUT_FILE"

jq -c '.rules[]' "$JSON_FILE" | while read -r rule; do
  for resource in $(echo "$rule" | jq -r '.resources[]'); do
    for verb in $(echo "$rule" | jq -r '.verbs[]'); do

      ALLOWED=$(oc auth can-i "$verb" "$resource" \
        --as="$USER_NAME" \
        --output=json 2>/dev/null | jq -r '.allowed')

      if [[ "$ALLOWED" == "true" ]]; then
        RESULT="ALLOWED"
      else
        RESULT="DENIED"
      fi

      printf "%-20s %-20s %-10s\n" "$resource" "$verb" "$RESULT" >> "$OUTPUT_FILE"
    done
  done
done

echo "‚úÖ Access report generated: $OUTPUT_FILE"
```

---

## üß™ Quick test (before running script)

Run this manually to confirm your cluster supports JSON output:

```bash
oc auth can-i get pods --as=<user> --output=json
```

If you see:

```json
{"allowed":true}
```

You‚Äôre good.

---

## üß† Extra debugging tip (if something still looks off)

Add this temporarily inside the loop:

```bash
echo "DEBUG: $verb $resource -> $ALLOWED"
```

This helps identify:

* invalid subresources
* verbs not supported for that resource
* missing impersonation rights

---

## üöÄ Optional upgrades

I can also:

* detect **subresource verbs automatically**
* add **namespace awareness**
* generate **CSV / HTML reports**
* compare **actual access vs ClusterRole rules**

Just say the word üëå
