Perfect ‚Äî here‚Äôs the **safest, race-free wait + validation combo** you can drop into your playbooks.
This pattern is **what SRE teams actually use** on OpenShift because it avoids **Terminating pods, pod name changes, and false passes**.

No guessing, no regex races.

---

# ‚úÖ SAFE RESTART ‚Üí WAIT ‚Üí VALIDATE (PRODUCTION-GRADE)

This assumes:

* `mstr_components` has `selector` that matches **deployment/statefulset names**
* You are restarting controllers (not pods)

---

## 1Ô∏è‚É£ Restart (controller only)

```yaml
- name: Restart selected components
  shell: |
    for r in $(oc get deployment,statefulset -n {{ namespace }} \
      | egrep -i "{{ item.selector }}" \
      | awk '{print $1}'); do
      echo "Restarting $r"
      oc rollout restart $r -n {{ namespace }}
    done
  loop: "{{ mstr_components }}"
```

Why this is safe:

* One restart per component
* No pod deletion
* No double restarts

---

## 2Ô∏è‚É£ WAIT ‚Äî **this is the critical part**

```yaml
- name: Wait for rollout to complete
  shell: |
    for r in $(oc get deployment,statefulset -n {{ namespace }} \
      | egrep -i "{{ item.selector }}" \
      | awk '{print $1}'); do
      echo "Waiting for rollout of $r"
      oc rollout status $r -n {{ namespace }} --timeout=600s
    done
  loop: "{{ mstr_components }}"
```

What this waits for:

* old pods **terminated**
* new pods **created**
* new pods **Ready**
* replicas count satisfied

üëâ **It will NOT continue while pods are Terminating**

---

## 3Ô∏è‚É£ VALIDATE ‚Äî only after rollout is stable

```yaml
- name: Validate no unhealthy pods for selected components
  shell: |
    oc get pods -n {{ namespace }} --no-headers \
    | egrep -i "{{ mstr_components | map(attribute='selector') | join('|') }}" \
    | egrep -i "CrashLoopBackOff|Error|ImagePullBackOff|ErrImagePull"
  register: badpods
  failed_when: badpods.stdout != ""
```

What this guarantees:

* rollout already finished
* only checks your components
* fails fast if anything unhealthy exists

---

## Optional (extra safety) ‚Äî ensure READY count matches

If you want **absolute certainty**:

```yaml
- name: Ensure all pods are Ready
  shell: |
    oc wait pod \
      -l app={{ item.selector }} \
      -n {{ namespace }} \
      --for=condition=Ready \
      --timeout=300s
  loop: "{{ mstr_components }}"
```

‚ö† Only use this if your labels are clean and consistent.

---

# üß† Why this combo never lies

| Stage                 | What it protects against |
| --------------------- | ------------------------ |
| Restart               | Double restarts          |
| Rollout status        | Terminating pods         |
| Validation            | Half-ready pods          |
| Label wait (optional) | Slow startups            |

---

## üö® What NOT to do (ever)

* ‚ùå `oc get all`
* ‚ùå wait on pod names
* ‚ùå delete pods manually
* ‚ùå regex-only pod matching
* ‚ùå `oc wait` during rollout

---

## Final note

If at any point this **still moves forward early**, that means:

* wrong deployment is matched
* selector is too broad
* controller is not Deployment/StatefulSet

Send me:

```bash
oc get deploy,sts -n <ns>
```

and **one** `item.selector`, and I‚Äôll lock it down 100%.


Got it üëç
You want **validation to fail** and clearly say **‚Äúcheck with support team‚Äù** if **any pod** goes into:

```
CrashLoopBackOff | Error | ImagePullBackOff | ErrImagePull
```

Here‚Äôs the **cleanest, reliable way** to do that in Ansible.

---

## ‚úÖ Correct validation task (with clear support message)

```yaml
- name: Check for unhealthy pods (selected components only)
  shell: |
    oc get pods -n {{ namespace }} --no-headers \
    | egrep -i "{{ mstr_components | map(attribute='selector') | join('|') }}" \
    | egrep -i "CrashLoopBackOff|Error|ImagePullBackOff|ErrImagePull" || true
  register: badpods

- name: Fail if unhealthy pods found
  fail:
    msg: |
      ‚ùå Unhealthy pods detected.
      Please check with support team.

      Affected pods:
      {{ badpods.stdout }}
  when: badpods.stdout != ""
```

---

## Why this works (important details)

### ‚úî `|| true`

Prevents the shell task from failing immediately, so Ansible can:

* capture output
* print a clean, controlled error message

### ‚úî Separate `fail` task

Gives you:

* readable failure
* exact pods listed
* clear instruction to contact support

---

## Example failure output (what you‚Äôll see)

```
FAILED! => {
  "msg": "‚ùå Unhealthy pods detected.
Please check with support team.

Affected pods:
myapp-7d9c8d9f5c-x2k8l   CrashLoopBackOff
backend-0               ImagePullBackOff"
}
```

That‚Äôs exactly what ops teams want during incident triage.

---

## Optional: make it extra strict (only after rollout)

This **must come AFTER**:

```yaml
oc rollout status deployment/statefulset
```

Otherwise you may catch temporary states.

---

## Summary

‚úî Detects bad pod states
‚úî Stops the playbook
‚úî Clear ‚Äúcheck with support team‚Äù message
‚úî Lists affected pods
‚úî No false positives

If you want, I can also:

* auto-attach `oc describe pod`
* auto-fetch recent logs
* dump events for support

Just say the word üëå

