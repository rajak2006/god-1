#!/usr/bin/env bash
set -e

get_tag() { echo "$1" | awk -F':' '{print $NF}'; }

# -----------------------------
# Versions
# -----------------------------
K8S_VERSION=$(oc version -o json | jq -r '.serverVersion.gitVersion')
OCP_VERSION=$(oc get clusterversion version -o jsonpath='{.status.desired.version}')
OC_VERSION=$(oc version --client | awk '{print $3}')

# -----------------------------
# Service Mesh
# -----------------------------
SM_VERSION=$(oc get csv -A -o jsonpath='{range .items[*]}{.metadata.name}{"|"}{.spec.version}{"\n"}{end}' \
  | grep -i servicemesh | awk -F'|' '{print $2}' | sort -V | tail -n1)

[[ -z "$SM_VERSION" ]] && SM_RESULT="NOT INSTALLED" || SM_RESULT="INSTALLED ($SM_VERSION)"

# -----------------------------
# Storage & Ingress
# -----------------------------
STORAGE_CLASSES=$(oc get sc -o jsonpath='{range .items[*]}{.metadata.name}{" "}{end}' | sed 's/ $//')
INGRESS_CONTROLLERS=$(oc get ingresscontroller -A -o jsonpath='{range .items[*]}{.metadata.name}{" "}{end}' | sed 's/ $//')

# -----------------------------
# cert-manager
# -----------------------------
CERT_CSV=$(oc get csv -A | grep -i cert-manager | head -n1 || true)
if [[ -n "$CERT_CSV" ]]; then
  CERT_RESULT="OLM ($(echo "$CERT_CSV" | awk '{print $3}'))"
else
  CERT_IMAGE=$(oc get pods -A -l app=cert-manager -o jsonpath='{.items[0].spec.containers[0].image}' 2>/dev/null || true)
  [[ -n "$CERT_IMAGE" ]] && CERT_RESULT="NOT OLM ($(get_tag "$CERT_IMAGE"))" || CERT_RESULT="NOT INSTALLED"
fi

# -----------------------------
# PostgreSQL
# -----------------------------
PG_IMAGE=$(oc get pods -A -o jsonpath='{range .items[*]}{.spec.containers[*].image}{"\n"}{end}' | grep -Ei 'postgres|postgresql' | head -n1 || true)
[[ -n "$PG_IMAGE" ]] && PG_RESULT="NOT OLM ($(get_tag "$PG_IMAGE"))" || PG_RESULT="NOT INSTALLED"

# -----------------------------
# MicroStrategy CMC
# -----------------------------
CMC_CSV=$(oc get csv -A | grep -i microstrategy | head -n1 || true)
if [[ -n "$CMC_CSV" ]]; then
  CMC_RESULT="OLM ($(echo "$CMC_CSV" | awk '{print $3}'))"
else
  CMC_IMAGE=$(oc get pods -A | grep -i cmc | awk '{print $1}' | head -n1 || true)
  [[ -n "$CMC_IMAGE" ]] && CMC_RESULT="NOT OLM" || CMC_RESULT="NOT INSTALLED"
fi

# -----------------------------
# BOXED LIST OUTPUT
# -----------------------------
cat <<EOF
+--------------------------------------------------+
| OpenShift Version        : $OCP_VERSION
| Kubernetes Version       : $K8S_VERSION
| OC CLI Version           : $OC_VERSION
+--------------------------------------------------+
| Service Mesh Operator    : $SM_RESULT
| cert-manager             : $CERT_RESULT
| PostgreSQL               : $PG_RESULT
| MicroStrategy CMC        : $CMC_RESULT
+--------------------------------------------------+
| Storage Classes          : $STORAGE_CLASSES
| Ingress Controllers      : $INGRESS_CONTROLLERS
+--------------------------------------------------+
EOF
