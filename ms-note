#!/usr/bin/env bash

set -e

echo "=========================================="
echo " OpenShift Cluster Audit"
echo "=========================================="

# ---------------------------
# Cluster versions
# ---------------------------
echo ">> Cluster Versions"
K8S_VERSION=$(oc version -o json | jq -r '.serverVersion.gitVersion')
# Robust OpenShift version
OCP_VERSION=$(oc get clusterversion version -o jsonpath='{.status.desired.version}' 2>/dev/null || "")
if [[ -z "$OCP_VERSION" ]]; then
    OCP_VERSION=$(oc version -o json | jq -r '.openshiftVersion // "N/A"' 2>/dev/null)
fi
OC_VERSION=$(oc version --client | awk '{print $3}')

echo "Kubernetes Version : $K8S_VERSION"
echo "OpenShift Version  : $OCP_VERSION"
echo "OC CLI Version     : $OC_VERSION"
echo

# -----------------------------
# Service Mesh Operator
# -----------------------------
SERVICE_MESH_VERSION=$(oc get csv -A -o jsonpath='{range .items[*]}{.metadata.name}{"|"}{.spec.version}{"\n"}{end}' \
    | grep -i servicemesh | awk -F'|' '{print $2}' | sort -V | tail -n1)

if [[ -z "$SERVICE_MESH_VERSION" ]]; then
    echo "Service Mesh Operator: NOT INSTALLED"
else
    echo "Service Mesh Operator: INSTALLED $SERVICE_MESH_VERSION"
fi

# ---------------------------
# Storage Classes
# ---------------------------
echo ">> Storage Classes"
oc get sc -o custom-columns=NAME:.metadata.name,PROVISIONER:.provisioner
echo

# ---------------------------
# Ingress Controllers
# ---------------------------
echo ">> Ingress Controllers"
oc get ingresscontroller -A -o custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,DOMAIN:.spec.domain,ROUTING:.status.domain
echo

# ---------------------------
# Operators/resources check
# ---------------------------
echo ">> Operators / Resources Check"
printf "%-25s %-15s %-30s\n" "RESOURCE/OPERATOR" "INSTALLED" "VERSION/INFO"
echo "---------------------------------------------------------------"

declare -A RESOURCES=(
    ["cert-manager"]="cert-manager"
    ["postgresql"]="postgresql"
    ["microstrategy-cmc"]="microstrategy-cmc"
)

for res in "${!RESOURCES[@]}"; do
    INSTALLED="NO"
    VERSION="N/A"

    # 1️⃣ Try CSV first (OLM-managed)
    CSV_INFO=$(oc get csv -A -o json | jq -r --arg op "$res" '
        .items[] | select(.metadata.name | test($op; "i")) 
        | "\(.metadata.namespace)|\(.metadata.name)|\(.spec.version // "N/A")|owner=\(.metadata.ownerReferences[0].name // "standalone")"
    ' 2>/dev/null || echo "")

    if [[ -n "$CSV_INFO" ]]; then
        INSTALLED="YES"
        VERSION=$(echo "$CSV_INFO" | awk -F'|' '{print $3 " (" $1 " / owner: " $4 ")"}' | paste -sd "," -)
    else
        # 2️⃣ Fallback: cert-manager CRD check
        if [[ "$res" == "cert-manager" ]]; then
            if oc get crd | grep -q cert-manager.io; then
                INSTALLED="YES"
                VERSION=$(oc get pods -A -l app=cert-manager -o jsonpath='{.items[0].spec.containers[0].image}' 2>/dev/null || "Installed (non-OLM)")
            fi
        fi
        # 3️⃣ Fallback: PostgreSQL pod image
        if [[ "$res" == "postgresql" ]]; then
            PG_IMAGE=$(oc get pods -A -o jsonpath='{range .items[*]}{.spec.containers[*].image}{"\n"}{end}' \
                | grep -Ei 'postgres|postgresql' | head -n 1)
            if [[ -n "$PG_IMAGE" ]]; then
                INSTALLED="YES"
                VERSION="$PG_IMAGE"
            fi
        fi
        # 4️⃣ Fallback: MicroStrategy CMC operator pods
        if [[ "$res" == "microstrategy-cmc" ]]; then
            CMC_IMAGE=$(oc get pods -A -o jsonpath='{range .items[*]}{.spec.containers[*].image}{"\n"}{end}' \
                | grep -i 'cmc' | head -n 1)
            if [[ -n "$CMC_IMAGE" ]]; then
                INSTALLED="YES"
                VERSION="$CMC_IMAGE"
            fi
        fi
    fi

    printf "%-25s %-15s %-30s\n" "$res" "$INSTALLED" "$VERSION"
done

echo "---------------------------------------------------------------"
echo "Audit Complete."
